name: Build HLSL Shaders

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Find DXC from the installed Windows SDK and add it to PATH
    - name: Locate and expose DirectX Shader Compiler (DXC)
      shell: pwsh
      run: |
        $dxc = Get-ChildItem "C:\Program Files (x86)\Windows Kits\" -Recurse -Filter dxc.exe -ErrorAction SilentlyContinue |
               Where-Object { $_.FullName -like "*\x64\*" } |
               Sort-Object FullName -Descending |
               Select-Object -First 1

        if (-not $dxc) {
          Write-Error "DXC (dxc.exe) not found on this runner."
          exit 1
        }

        Write-Host "Found DXC at: $($dxc.FullName)"

        # Add the directory to PATH for the rest of the job
        $dxcDir = Split-Path $dxc.FullName -Parent
        $dxcDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

        # Optional: show version for logs
        & "$($dxc.FullName)" -help | Select-Object -First 5

    - name: Compile all HLSL shaders
      shell: pwsh
      run: |
        ./tools/compile_shaders.ps1 -Root "./hlsl"

    - name: Upload compiled shaders as artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: compiled-shaders
        path: |
          **/*.cso
