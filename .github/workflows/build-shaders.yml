name: Build HLSL Shaders

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: true

    - name: Locate and expose DirectX Shader Compiler (DXC)
      shell: pwsh
      run: |
        $dxc = Get-ChildItem "C:\Program Files (x86)\Windows Kits\" -Recurse -Filter dxc.exe -ErrorAction SilentlyContinue |
               Where-Object { $_.FullName -like "*\x64\*" } |
               Sort-Object FullName -Descending |
               Select-Object -First 1

        if (-not $dxc) {
          Write-Error "DXC (dxc.exe) not found on this runner."
          exit 1
        }

        Write-Host "Found DXC at: $($dxc.FullName)"

        $dxcDir = Split-Path $dxc.FullName -Parent
        $dxcDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

        & "$($dxc.FullName)" -help | Select-Object -First 5

    - name: Compile all HLSL shaders
      shell: pwsh
      run: |
        ./tools/compile_shaders.ps1 -Root "./hlsl"

    - name: Generate shaders manifest (shaders.json)
      shell: pwsh
      run: |
        ./tools/gen_shaders_manifest.ps1

    - name: Commit updated shaders.json
      if: github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
      shell: pwsh
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git add docs/shaders.json

        if (git diff --cached --quiet) {
          Write-Host "No changes in docs/shaders.json, nothing to commit."
        }
        else {
          git commit -m "Update shaders manifest [skip ci]"
          git push origin HEAD:main
        }

    - name: Upload compiled shaders as artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: compiled-shaders
        path: |
          **/*.cso
